<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synpatico Express Middleware Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .json-container {
            background: #1a1a1a;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .json-container h4 {
            color: white;
            margin-bottom: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .size-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .logs {
            background: #0a0a0a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .savings-highlight {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Synpatico Express Demo</h1>
            <p>Watch real-time bandwidth optimization in action</p>
        </div>

        <div class="demo-section">
            <h2>üéÆ Interactive API Testing</h2>
            <p>Click any endpoint to see the two-phase optimization process:</p>
            
            <div class="controls">
                <button onclick="testEndpoint('/api/users')">üë• Test Users API</button>
                <button onclick="testEndpoint('/api/products')">üõçÔ∏è Test Products API</button>
                <button onclick="testEndpoint('/api/dashboard')">üìä Test Dashboard API</button>
            </div>

            <h3>üìä Per-Endpoint Statistics</h3>
            <div id="endpointStats">
                <p style="color: #666; font-style: italic;">Make API requests to see per-endpoint breakdown...</p>
            </div>

            <div id="savingsHighlight" class="savings-highlight" style="display: none;"></div>

            <div class="comparison">
                <div class="json-container">
                    <h4>üì¶ Standard JSON Response</h4>
                    <div class="size-badge" id="originalSize">0 bytes</div>
                    <pre id="originalJson">Click an API endpoint to see the response...</pre>
                </div>
                <div class="json-container">
                    <h4>‚ö° Optimized Response</h4>
                    <div class="size-badge" id="optimizedSize">0 bytes</div>
                    <pre id="optimizedJson">Optimization will appear after the second request...</pre>
                </div>
            </div>

            <div class="logs" id="logs">
                <div class="log-entry">üí° Ready to demonstrate Synpatico optimization...</div>
            </div>
        </div>
    </div>

    <script>
        let structureIds = {};
        let requestCount = 0;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.animationDelay = '0s';
            
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? '‚úÖ' : type === 'optimization' ? 'üöÄ' : type === 'learning' ? 'üß†' : 'üìù';
            entry.textContent = `[${timestamp}] ${emoji} ${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + sizes[i];
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        async function testEndpoint(endpoint) {
            requestCount++;
            const button = event.target;
            const originalText = button.textContent;
            button.innerHTML = '<span class="loading"></span> Loading...';
            button.disabled = true;

            try {
                addLog(`Making request to ${endpoint}...`);
                
                // First request (learning phase)
                const headers = {};
                if (structureIds[endpoint]) {
                    headers['X-Synpatico-Accept-ID'] = structureIds[endpoint];
                    addLog(`Sending optimization header: ${structureIds[endpoint]}`, 'optimization');
                }

                const response = await fetch(endpoint, { headers });
                const data = await response.json();
                
                // Parse response headers
                const synpaticoMode = response.headers.get('X-Synpatico-Mode');
                const structureId = response.headers.get('X-Synpatico-Structure-ID') || response.headers.get('X-Synpatico-ID');
                const originalSize = response.headers.get('X-Synpatico-Original-Size');
                const optimizedSize = response.headers.get('X-Synpatico-Optimized-Size');
                const savings = response.headers.get('X-Synpatico-Savings');
                const contentType = response.headers.get('Content-Type');

                // Update UI based on response type
                if (synpaticoMode === 'learning') {
                    // Learning phase
                    structureIds[endpoint] = structureId;
                    addLog(`Learning phase: Structure ID ${structureId} cached`, 'learning');
                    addLog(`Next request to ${endpoint} will be optimized!`, 'success');
                    
                    document.getElementById('originalJson').textContent = formatJSON(data);
                    document.getElementById('originalSize').textContent = formatBytes(JSON.stringify(data).length);
                    document.getElementById('optimizedJson').textContent = 'Make the same request again to see optimization...';
                    document.getElementById('optimizedSize').textContent = 'Pending';
                    
                } else if (contentType.includes('synpatico')) {
                    // Optimization phase - data is already reconstructed by server
                    const originalBytes = parseInt(originalSize);
                    const optimizedBytes = parseInt(optimizedSize);
                    const percentSaved = Math.round(((originalBytes - optimizedBytes) / originalBytes) * 100);
                    
                    addLog(`Optimized response: ${formatBytes(originalBytes)} ‚Üí ${formatBytes(optimizedBytes)} (${percentSaved}% saved)`, 'optimization');
                    addLog(`Client received reconstructed data (${formatBytes(JSON.stringify(data).length)} bytes)`, 'success');
                    
                    // Show reconstructed data (what client actually gets)
                    document.getElementById('originalJson').textContent = formatJSON(data);
                    document.getElementById('originalSize').textContent = `${formatBytes(originalBytes)} (original)`;
                    document.getElementById('optimizedJson').textContent = `Payload sent over network was ${formatBytes(optimizedBytes)} of optimized values`;
                    document.getElementById('optimizedSize').textContent = formatBytes(optimizedBytes);
                    
                    // Show savings highlight
                    const highlight = document.getElementById('savingsHighlight');
                    highlight.textContent = `üéâ ${percentSaved}% bandwidth saved! That's ${formatBytes(originalBytes - optimizedBytes)} less data transferred.`;
                    highlight.style.display = 'block';
                    
                    setTimeout(() => {
                        highlight.style.display = 'none';
                    }, 5000);
                }

                // Update statistics
                await fetchStats();

            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                console.error('Request failed:', error);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function displayEndpointStats(endpoints) {
            const container = document.getElementById('endpointStats');
            
            if (!endpoints || Object.keys(endpoints).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Make API requests to see per-endpoint breakdown...</p>';
                return;
            }
            
            let html = '<div class="stats-grid">';
            
            Object.entries(endpoints).forEach(([path, stats]) => {
                const savingsPercent = stats.optimizedRequests > 0 ? 
                    Math.round(((stats.bytesSaved / stats.optimizedRequests) / stats.optimizedRequests) * 100) : 0;
                
                html += `
                    <div class="stat-card">
                        <h4 style="margin-bottom: 10px; color: #667eea;">${path}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left;">
                            <div><strong>Requests:</strong> ${stats.totalRequests}</div>
                            <div><strong>Optimized:</strong> ${stats.optimizedRequests}</div>
                            <div><strong>Bytes Saved:</strong> ${formatBytes(stats.bytesSaved)}</div>
                            <div><strong>Avg Savings:</strong> ${formatBytes(stats.averageSavings)}</div>
                        </div>
                        ${stats.lastStructureId ? `<div style="margin-top: 8px; font-size: 0.8em; color: #666;">Structure ID: ${stats.lastStructureId.substring(0, 8)}...</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function fetchStats() {
            try {
                const response = await fetch('/stats/synpatico');
                const stats = await response.json();
                
                // Display per-endpoint stats
                displayEndpointStats(stats.endpoints);
                    
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        // Initial stats load
        fetchStats();
        
        // Add some helpful tips
        setTimeout(() => {
            addLog('üí° Tip: Click the same endpoint twice to see the optimization in action!');
        }, 2000);
        
        setTimeout(() => {
            addLog('üí° Watch the Network tab in DevTools to see the actual payload sizes');
        }, 4000);
    </script>
</body>
</html>